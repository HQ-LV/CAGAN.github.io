<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAGAN for Light Pollution Control</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <link href='./style.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script src="./lib/jquery-3.4.1.min.js"></script>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: rgba(0, 0, 0);
            color: #fff;
        }

        header {
            height: 120px;
            line-height: 105px;
            color: #fff;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        header label {
            font-size: 35px;
            font-weight: bold;
            margin-left: 35px;
        }

        header ul {
            display: inline-flex;
            gap: 20px;
            margin-right: 30px;
            /* position: absolute;
            right: 30px; */
        }

        header li {
            list-style: none;
            font-size: 16px;
            height: 70px;
            cursor: pointer;
        }

        header li.active {
            border-bottom: 1px solid #fff;
        }

        #map-container {
            display: flex;
            width: 100%;
            height: calc(100% - 120px);
            /* gap: 10px;  */
            justify-content: space-between;
        }

        #map-left {
            flex: 1;
            flex-basis: calc(50% - 10px);
            margin-right: 10px;
            /* flex: 2; 
            border: 1px solid #ccc; 
            flex-grow: 1; */
        }

        #map-right {
            flex: 1;
            flex-basis: calc(50% - 20px);
            margin-right: 10px;
        }

        #ate-chart {
            flex: 1;
            flex-basis: calc(25% - 10px);
            /* flex: 1;  */
            /* flex-grow: 0; */
            /* border: 1px solid #ccc;  */
        }

        #controls {
            position: absolute;
            top: 76px;
            left: 30px;
            z-index: 1;
            padding: 10px;
            border-radius: 3px;
            color: #ccc;
            display: flex;
        }

        #controls label {
            font-size: 20px;
            color: #fff;
            margin-right: 38px;
        }

        #controls div {
            margin-right: 10px;
            cursor: pointer;
            border: 0.5px solid #ccc;
            padding: 2px 3px;
        }

        #controls div.active {
            border: 1px solid rgb(251, 104, 72);
            color: rgb(251, 104, 72);
        }

        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            /* background: #000000cf; */
            padding: 10px;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* 添加这一行 */
        }

        nav {
            position: absolute;
            /* 使导航栏绝对定位 */
            top: 10px;
            /* 距离顶部10px */
            right: 10px;
            /* 距离右侧10px */
            z-index: 2;
            /* 确保在其他元素之上 */
            background: white;
            /* 背景颜色 */
            padding: 5px;
            /* 内边距 */
            border-radius: 3px;
            /* 圆角 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* 阴影效果 */
        }

        /* linear-gradient 颜色条
        https://cssgradient.io/ 
        https://stackoverflow.com/questions/67283747/html-color-bar-how-to */
        /* 颜色搭配
        https://colors.eva.design/ */
        .colorbar-right {
            height: 20px;
            background: linear-gradient(90deg, rgba(255,255,204,1) 0%, rgba(254,217,118,1) 20%,  rgba(253,141,60,1) 100%);; /* 示例渐变颜色 */
        }
        .colorbar-left {
            height: 20px;
            background: linear-gradient(90deg, rgba(255,255,204,1) 0%, rgba(255,192,174,1) 20%, rgba(255,151,133,1) 40%, rgba(255,53,60,1) 100%);
        }

    
           
    </style>
</head>

<body>
    <header>
        <label>因果感知生成对抗网络: 光污染控制</label>
        <ul id="navigation" style="position: absolute; right: 80px;">
            <li value="A" class="active">光污染成因分析</li>
            <li value="B">因果可解释性分析</li>
        </ul>

        <ul style="position: absolute; right: 15px;">
            <li onclick="window.location.href='index-en.html'">EN</li>
            
        </ul>
    </header>

    <div id="controls">
        <!-- <label>City:</label> -->
        <div value="beijing" class="active">北京</div>
        <!-- <div value="shanghai">Shanghai</div> -->
        <!-- <div value="guangzhou">Guangzhou</div> -->
        <div value="london">伦敦</div>
        <div value="losAngeles">洛杉矶</div>
        <!-- <div value="paris">Paris</div> -->
        <!-- <div value="newyork">NewYork</div> -->
    </div>

    <div id="map-container">
        <div id="map-left">
            <div class="map-controls"  >
                <select id="poiSelect">
                   
                    <option value="residential_mean_NTL">居住区 NTL</option>
                    <option value="industrial_mean_NTL">工业区 NTL</option>
                    <option value="retail_mean_NTL">零售区 NTL</option>
                    <option value="brownfield_mean_NTL">棕地区 NTL</option>
                    <option value="commercial_mean_NTL">商业区 NTL</option>
                    <option value="construction_mean_NTL">建筑区 NTL</option>
                    <option value="farmland_mean_NTL">农田 NTL</option>
                    <option value="forest_mean_NTL">森林 NTL</option>
                    <option value="grass_mean_NTL">草地 NTL</option>

                </select>

                <div class="colorbar-left" style="display: flex; justify-content: space-between;">
                    <span style="color: #FF353C;">0</span>
                    <span style="color: #FFE3D6;">100</span>
                  
                </div>

                
            </div>
        </div>
        <div id="map-right">
            <div class="map-controls"  >
                <select id="indicatorSelect"  >
                    <option value="Over_illumination">过度照明</option>
                    <option value="Trespass">光侵入</option>
                    <option value="Clutter">光杂波</option>
                </select>
               

                <div class="colorbar-right" style="display: flex; justify-content: space-between;">
                    <span style="color: #fd8d3c;">0</span>
                    <span id="indicator_span" style="color: #ffffcc;">25000</span>

 
                </div>
            </div> 


            <!-- <div class="map-controls" style="display: flex; align-items: center;">
                <select id="indicatorSelect" style="margin-right: 10px;">
                    <option value="Over_illumination">Over_illumination</option>
                    <option value="Trespass">Trespass</option>
                    <option value="Clutter">Clutter</option>
                </select>

                <div class="colorbar"></div>
            </div>  -->

        </div>

        <div id="ate-chart" class="bar-chart">
            <!-- <h1 style="color: #fff;">Causal Inference</h1> -->
            <!-- <div style="height: 550px;     width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;  "> -->


            <!-- <p style="width: 80%;">We apply causal inference to investigate the complex links between residential light pollution and various POIs in a specific area, uncovering fundamental causal mechanisms.</p> -->
            <!-- <p style="width: 80%;">The left map shows NTL (Nighttime Light Intensity) for each building type.</p>
            <p style="width: 80%;">The right map shows the city's light pollution. A larger ATE(Average Treatment Effect) value indicates a greater impact of the building type on the light pollution indicator.</p>
            <p style="width: 80%;">A larger ATE(Average Treatment Effect) value indicates a greater impact of the building type on the light pollution indicator.</p> -->

            <p style="width: 80%; line-height: 1.5;">左侧地图展示了各类建筑的NTL(夜间灯光强度)。</p>
            <p style="width: 80%; line-height: 1.5;">右侧地图展示了城市的整体光污染情况。</p>
            <p style="width: 80%; line-height: 1.5;">ATE(平均处理效应)值越大，表明该建筑类型对光污染指标的影响更为显著。</p>


            


        <div style="height: 500px;     width: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-end; ">
                <!-- <div class="bar" id="bar" data-value="0" style="background-color: #FFFC6A;"></div> -->
                <div class="bar" id="bar" data-value="ATE" style="background-color: #feb1f3;width: 60px; border-radius: 3px; box-shadow: 0 2px 2px rgba(0, 0, 0, 0.2);"></div>
                <br>
                <!-- <span >-0.4</span> -->
            </div>
            
        </div>
    </div>


    <!-- <div id="image-container" style="display: none;width: 70%;margin: auto;"> -->
    <div id="image-container" style="display: none; justify-content: space-between; align-items: center;"> 
        <div id="parcels" style="flex: 0 0 70%;     width: 70%; "> 
        <div style="display: flex;justify-content: space-around; align-items: center; height: 130px;">
            <div>
                <button id="changeParcelButton"
                style="width: 180px; height: 50px; background: rgb(251, 104, 72); color: #fff; border: none; border-radius: 5px; cursor: pointer;">切换地块</button> <!-- 添加按钮 -->
                
            </div>
                <div style=" text-align: right;width: 360px;">
                <div style="display: flex;justify-content: space-between;align-items: center;">
                <label style="width: 180px;">居住区NTL变化</label> <!-- 只能取 0 +1 +5  -->
                <!-- <input type="range" id="residentialSlider" min="-5" max="5" value="1" step="1" onchange="updateImage()" oninput="this.value = (this.value < 1) ? 0 : (this.value > 5) ? 5 : (this.value % 4 === 0 ? this.value : (this.value < 3 ? 1 : 5));"> 仅允许选择1和5 -->
                <!-- <input type="range" id="residentialSlider" min="-5" max="5" value="0" step="1" onchange="updateImage()" oninput="this.value = (this.value <= 1) ? 1 : 5;"> 选择小于等于1返回1，大于1返回5 -->
                <!-- <input type="range" id="residentialSlider" min="-5" max="5" value="1" step="1" onchange="updateImage()" oninput="this.value = (this.value <= 0) ? 0 : (this.value === 1 ? 1 : 5);"> 选择小于等于0返回0，等于1返回1，大于1返回5  -->
                <input type="range" id="residentialSlider" min="-5" max="5" value="0" step="1" onchange="updateImage()"
                    oninput="this.value = (this.value <= 0) ? 0 : (this.value >= 3) ? 5 : 1;" style="margin: 8px 5px;;">
                <span>0</span>
            </div>
            <div style="display: flex;justify-content: space-between;align-items: center;">
                <label style="width: 180px;">商业区NTL变化</label> <!-- 只能取 0 +1 +5  -->
                <input type="range" id="commercialSlider" min="-5" max="5" value="0" step="1" onchange="updateImage()"
                    oninput="this.value = (this.value <= 0) ? 0 : (this.value >= 3) ? 5 : 1;" style="margin: 8px 5px;"> 
                    <span>0</span><!-- 仅允许选择1和5 -->
                </div>
            <div style="display: flex;justify-content: space-between;align-items: center;">
                <label style="width: 180px;">建筑区NTL变化</label> <!-- 只能取 0 +1 +5  -->
                <input type="range" id="constructionSlider" min="-5" max="5" value="0" step="1" onchange="updateImage()"
                    oninput="this.value = (this.value <= 0) ? 0 : (this.value >= 3) ? 5 : 1;" style="margin: 8px 5px;"> 
                    <span>0</span> <!-- 仅允许选择1和5 -->
                </div>
            <div style="display: flex;justify-content: space-between;align-items: center;">
                <label style="width: 180px;">草地NTL变化</label> <!-- 只能取 -5 0  -->
                <!-- <input type="range" id="grasslandSlider" min="-5" max="5" value="0" step="1" onchange="updateImage()" oninput="this.value = -5;"> 仅允许选择-5 -->
                <input type="range" id="grasslandSlider" min="-5" max="5" value="0" step="1" onchange="updateImage()"
                    oninput="this.value = (this.value < 0) ? -5 : 0;" style="margin: 8px 5px;"> <!-- 如果小于0，则为-5，如果大于等于0，则为0 -->
                    <span>0</span>
                </div>
            </div>
        </div>
        <div style="display: flex; margin-top: 30px; justify-content: space-between; align-items: center;">
            <div style="flex: 1; text-align: center;">
                <!-- <img id="groundTruthImage" src="./data/fig/1000.jpg" alt="Ground Truth" style="width: 400px; height: auto;"> -->

                <div style="border: 8px solid transparent; padding: 10px; display: inline-block; border-radius: 4px; "> <!-- 添加边框 -->
                    <img id="groundTruthImage" src="./data/fig/1000.jpg" alt="Ground Truth" style="width: 400px; height: auto;">
                </div>
                <p style="margin-top: 20px;">真实的光污染情况</p>
            </div>
            <div style="flex: 1; text-align: center;">
                <!-- <img id="generatedImage" src="./data/fig/1000.jpg" alt="Generation" style="width: 400px; height: auto;"> -->
                <div style="border: 8px solid rgb(251, 104, 72); padding: 10px; display: inline-block; border-radius: 4px; box-shadow: 0 0 15px rgba(255, 255, 255, 0.7)"> <!-- 添加边框 -->
                    <img id="generatedImage" src="./data/fig/1000.jpg" alt="Generation" style="width: 400px; height: auto;">
                </div>
                
                
                <p style="margin-top: 20px;">生成的光污染情况</p>
            </div>
        </div>
        </div>

        <div id="cagan-describe" style="flex: 0 0 25%; width: 25%; display: flex; flex-direction: column; justify-content: flex-start;"> 
            <h3 style="font-size: 20px; line-height: 1.5">CAGAN</h3>
            <br>
            <!-- <p style="width: 80%;">We apply causal inference to investigate the complex links between residential light pollution and various POIs in a specific area, uncovering fundamental causal mechanisms.</p> -->
            <p style="width: 80%; line-height: 1.5;">阶段1: 训练一个光污染图像分类器，使用实际的光污染图像，使其能够与给定的居民区光污染地图建立准确的关联。</p>
            <br>
            <p style="width: 80%; line-height: 1.5;">阶段2: 仅使用基础地图进行训练，不进行着色，训练一个条件变分自编码器。然后，生成器在分类器和判别器的指导下，逐步生成真实的光污染地图。</p>
            <br>
            <p style="width: 80%; line-height: 1.5;">因果可解释性：调整居民区内不同建筑类型的平均夜间光强度，模型将对该区域生成新的光污染情况。</p>
            
        </div>

    </div>

    <div id="team-zh" style=" margin: 50px auto; padding: 20px; text-align: left; font-family: Arial, sans-serif;   box-shadow: 0 0 15px rgba(255, 255, 255, 0.7)">
 
        <div style="display: flex; justify-content: space-between; padding: 10px;">
            <div style="flex: 1; padding: 10px; margin-left: 100px;  ">
                <h3 style="font-size: 20px; line-height: 1.5">论文</h3>
                <p style="line-height: 1.5;">Causally Aware Generative Adversarial Networks for Light Pollution Control.</p>
                
                <p style="line-height: 1.5;;">Yuyao Zhang, Ke Guo, Xiao Zhou. In Proceedings of the 38th Annual AAAI Conference on Artificial Intelligence (AAAI 2024).</p>
              
                <p style="line-height: 1.5;">
                    论文链接: <a href="https://arxiv.org/abs/2401.06453" target="_blank" style="color: #fff; text-decoration: underline;">https://arxiv.org/abs/2401.06453</a>.
                </p>
                <p style="line-height: 1.5;">
                    代码链接: <a href="https://github.com/YuyaoZhangQAQ/Light_Pollution_CAGAN" target="_blank" style="color: #fff; text-decoration: underline;">https://github.com/YuyaoZhangQAQ/Light_Pollution_CAGAN</a>.
                </p>

         
            </div>
             
            <div style="flex: 1; padding: 10px; margin-right: 100px;  "> 
                <!-- <h3 style="font-size: 20px; line-height: 1.5">Team</h3> -->
                <div style="display: flex; justify-content: right; gap: 20px;"> <!-- 添加一个flex容器 -->
                    <img src="./data/logo/lumos-logo.jpg" alt="Logo" style="width: 150px; height: 150px;"/>
                    <img src="./data/logo/lumos-gzh.jpg" alt="Subscription" style="width: 150px; height: 150px;"/>
                </div>
            </div>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmFvYmkiLCJhIjoiY20yMXp0MWp3MDF1eDJpb2ZrdHh1ZDNhMCJ9.Ve6bYgzCzDV5G64ZfYGm3w';

        var mapLeft = new mapboxgl.Map({
            container: 'map-left',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [116.4074, 39.9042], // 默认显示北京
            zoom: 10,
            pitch: 45,// 添加这一行
            bearing: -30,
            antialias: true, // 启用抗锯齿
            touchRotate: true,
        });

        var mapRight = new mapboxgl.Map({
            container: 'map-right',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [116.4074, 39.9042], // 默认显示北京
            zoom: 10,
            pitch: 45, // 添加这一行
            bearing: -30,
            antialias: true, // 启用抗锯齿
            touchRotate: true,
        });

        var cityData = {
            'beijing': './data/Beijing_data.geojson',
            'shanghai': './data/Shanghai_data.geojson',
            'guangzhou': './data/Guangzhou_data.geojson',
            'london': './data/London_data.geojson',
            'losAngeles': './data/LosAngeles_data.geojson',
            'paris': './data/Paris_data.geojson',
            'newyork': './data/Newyork_data.geojson',
        };

        var currentCity = 'beijing';
        var currentIndicator = 'Over_illumination';
        var currentPoi = 'residential_mean_NTL';

        function updateMap() {
            fetch(cityData[currentCity])
                .then(response => response.json())
                .then(data => {

                    // 移除现有图层
                    removeExistingLayers(mapLeft);
                    removeExistingLayers(mapRight);

                    // 为每种几何类型添加新图层
                    addGeometryLayers(mapLeft, data, 'left');
                    addGeometryLayers(mapRight, data, 'right');

                    var bounds = new mapboxgl.LngLatBounds();

                    data.features.forEach(function (feature) {
                        if (feature.geometry) {


                            // 扩展边界框
                            extendBounds(bounds, feature.geometry);
                        }
                    });
                    // console.log('扩展完边界了')

                    if (!bounds.isEmpty()) {
                        mapLeft.fitBounds(bounds, { padding: 50 });
                        mapRight.fitBounds(bounds, { padding: 50 });
                    } else {
                        console.error('未找到有效的坐标数据');
                    }
                })
                .catch(error => {
                    console.error('加载城市数据时出错:', error);
                    alert('无法加载所选城市的数据，请检查数据格式或网络连接。');
                });
        }

        function removeExistingLayers(map) {
            const layerIds = ['points', 'lines', 'polygons'];
            layerIds.forEach(id => {
                if (map.getLayer(id)) map.removeLayer(id);
                if (map.getSource(id)) map.removeSource(id);
            });
        }

        function addGeometryLayers(map, data, side) {

            const layerIds = [`points-${side}`, `lines-${side}`, `polygons-${side}`];

            // 首先移除已存在的图层
            layerIds.forEach(id => {
                if (map.getLayer(id)) {
                    map.removeLayer(id);
                }
                if (map.getSource(id)) {
                    map.removeSource(id);
                }
            });

            function getPoiColor(poiType) {
                const poiColors = {
                    'residential_mean_NTL': '#e41a1c',
                    'industrial_mean_NTL': '#377eb8',
                    'retail_mean_NTL': '#4daf4a',
                    'brownfield_mean_NTL': '#984ea3',
                    'commercial_mean_NTL': '#ff7f00',
                    'construction_mean_NTL': '#ffff33',
                    'farmland_mean_NTL': '#a65628',
                    'forest_mean_NTL': '#f781bf',
                    'grass': '#999999'
                };
                return poiColors[poiType] || '#000000'; // 默认黑色
            }

            // // 点图层
            // if (data.features.some(f => f.geometry.type === 'Point')) {
            //     map.addLayer({
            //         id: `points-${side}`,
            //         type: 'circle',
            //         source: {
            //             type: 'geojson',
            //             data: {
            //                 type: 'FeatureCollection',
            //                 features: data.features.filter(f => f.geometry.type === 'Point')
            //             }
            //         },
            //         paint: {
            //             'circle-radius': 2,
            //             'circle-color': side === 'right' ?
            //                 [
            //                     'interpolate',
            //                     ['linear'],
            //                     ['get', currentIndicator],
            //                     0, '#ffffcc',
            //                     1, '#ffeda0',
            //                     2, '#fed976',
            //                     3, '#feb24c',
            //                     4, '#fd8d3c'
            //                 ] :
            //                 getPoiColor(currentPoi)
            //         }
            //     });
            // }

            // // 线图层
            // if (data.features.some(f => f.geometry.type === 'LineString')) {
            //     map.addLayer({
            //         id: `lines-${side}`,
            //         type: 'line',
            //         source: {
            //             type: 'geojson',
            //             data: {
            //                 type: 'FeatureCollection',
            //                 features: data.features.filter(f => f.geometry.type === 'LineString')
            //             }
            //         },
            //         paint: {
            //             'line-width': 2,
            //             // 'line-color': side === 'right' ? '#fd8d3c' : getPoiColor(currentPoi),
            //             'line-color': side === 'right' ?
            //                 [
            //                     'interpolate',
            //                     ['linear'],
            //                     ['get', currentIndicator],
            //                     0, '#ffffcc',
            //                     1, '#ffeda0',
            //                     2, '#fed976',
            //                     3, '#feb24c',
            //                     4, '#fd8d3c'
            //                 ] :
            //                 getPoiColor(currentPoi)
            //         }
            //     });
            // }

            // 多边形图层
            // 多边形图层
            if (data.features.some(f => ['Polygon', 'MultiPolygon'].includes(f.geometry.type))) {
                

                // 添加图形的3D图层
                let heightFiled = null, fillExtrusionColor = null;

                if (side === 'left') {
                    // if (currentPoi == 'residential_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#D6E4FF',
                    //         10, '#ADC8FF',
                    //         20, '#84A9FF',
                    //         30, '#6690FF',
                    //         60, '#3366FF'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                    // if (currentPoi == 'industrial_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#FFE3D6',
                    //         20, '#FFC0AE',
                    //         40, '#FF9785',
                    //         60, '#FF6F67',
                    //         80, '#FF353C'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                    // if (currentPoi == 'retail_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#F8E6D0',
                    //         20, '#F1C9A4',
                    //         40, '#D79A70',
                    //         60, '#B06A46',
                    //         80, '#7c3419'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                    // if (currentPoi == 'brownfield_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#ffffcc',
                    //         20, '#ffeda0',
                    //         40, '#fed976',
                    //         60, '#feb24c',
                    //         80, '#fd8d3c'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                    // if (currentPoi == 'commercial_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#F3D6FF',
                    //         20, '#E2ADFF',
                    //         40, '#CE84FF',
                    //         60, '#BA66FF',
                    //         80, '#9A33FF'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                    // if (currentPoi == 'construction_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#D9FEFB',
                    //         20, '#B3FEFC',
                    //         40, '#8CF8FE',
                    //         60, '#70EBFD',
                    //         80, '#41D7FC'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }
                    // if (currentPoi == 'farmland_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#FEF1CC',
                    //         20, '#FDDF99',
                    //         40, '#F9C666',
                    //         60, '#F3AD3F',
                    //         80, '#eb8704'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                    // if (currentPoi == 'forest_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#E8F7C9',
                    //         20, '#CEEF97',
                    //         40, '#9FD05D',
                    //         60, '#6CA232',
                    //         90, '#336408'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                    // if (currentPoi == 'grass_mean_NTL') {
                    //     fillExtrusionColor = [
                    //         'interpolate',
                    //         ['linear'],
                    //         ['get', currentPoi],
                    //         0, '#F0FDD3',
                    //         30, '#DDFCA8',
                    //         60, '#C3F67B',
                    //         90, '#A8ED59',
                    //         120, '#81E226'
                    //     ];

                    //     heightFiled = ["*", ['get', currentPoi], 100];
                    // }

                        fillExtrusionColor = [
                            'interpolate',
                            ['linear'],
                            ['get', currentPoi],
                            0, '#FFE3D6',
                            25, '#FFC0AE',
                            50, '#FF9785',
                            75, '#FF6F67',
                            100, '#FF353C'
                        ];

                        heightFiled = ["*", ['get', currentPoi], 100];


                    // ... 其他左

                } else {

                    if (currentIndicator == 'Over_illumination') {
                        fillExtrusionColor = [
                            'interpolate',
                            ['linear'],
                            ['get', currentIndicator],
                            0, '#ffffcc',
                            5000, '#ffeda0',
                            10000, '#fed976',
                            15000, '#feb24c',
                            25000, '#fd8d3c'
                        ];

                        heightFiled = ["*", ['get', currentIndicator], 0.8];
                    }
                    if (currentIndicator == 'Trespass') {
                        fillExtrusionColor = [
                            'interpolate',
                            ['linear'],
                            ['get', currentIndicator],
                            0, '#ffffcc',
                            1, '#ffeda0',
                            2, '#fed976',
                            3, '#feb24c',
                            5, '#fd8d3c'
                        ];

                        heightFiled = ["*", ['get', currentIndicator], 2000];
                    }

                    if (currentIndicator == 'Clutter') {
                        fillExtrusionColor = [
                            'interpolate',
                            ['linear'],
                            ['get', currentIndicator],
                            0, '#ffffcc',
                            0.02, '#ffeda0',
                            0.04, '#fed976',
                            0.06, '#feb24c',
                            0.99, '#fd8d3c'
                        ];

                        heightFiled = ["*", ['get', currentIndicator], 1000000];
                    }
                    // ... 其他右
                }
                

                map.addLayer({
                    'id': `polygons-${side}`,
                    'type': 'fill-extrusion',
                    'source': {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: data.features.filter(f => ['Polygon', 'MultiPolygon'].includes(f.geometry.type))
                        }
                    },
                    'layout': {},
                    'paint': {
                        // 使用渐变颜色填充
                        'fill-extrusion-color': fillExtrusionColor,
                        // 控制锥形的高度，这里使用属性'height'来动态设置高度
                        'fill-extrusion-height': heightFiled
                    }
                });


            }
        }

        function extendBounds(bounds, geometry) {
            try {
                if (geometry.type === 'Point') {
                    bounds.extend(geometry.coordinates);
                } else if (geometry.type === 'LineString') {
                    geometry.coordinates.forEach(coord => bounds.extend(coord));
                } else if (geometry.type === 'Polygon') {
                    geometry.coordinates[0].forEach(coord => bounds.extend(coord));
                } else if (geometry.type === 'MultiPolygon') {
                    geometry.coordinates.forEach(polygon => {
                        polygon[0].forEach(coord => bounds.extend(coord));
                    });
                }
            } catch (error) {
                console.error('在扩展边界时发生错误:', error);
                console.error('问题特征:', JSON.stringify(geometry, null, 2));
            }
        }

        $('#controls').on('click', 'div', function (e) {
            $(this).addClass('active').siblings().removeClass('active');
            currentCity = $(this).attr('value');
            updateMap();
            updateChart();
        });

        document.getElementById('indicatorSelect').addEventListener('change', function (e) {
            currentIndicator = e.target.value;
            updateMap();
            updateChart();
        });

        document.getElementById('poiSelect').addEventListener('change', function (e) {
            currentPoi = e.target.value;
            updateMap();
            updateChart();
        });

        mapLeft.on('load', function () {
            updateMap();
            updateChart();
            console.log('mapLeft load');
        });

        mapRight.on('load', function () {
            updateMap();
            updateChart();
            console.log('mapRight load');
        });

        // 拖拽
        mapLeft.on("drag", function () {
            mapLeft_x = mapLeft.getCenter().lng;
            mapLeft_y = mapLeft.getCenter().lat;
            mapRight.setCenter([mapLeft_x, mapLeft_y]);
        });
        mapRight.on("drag", function () {
            mapRight_x = mapRight.getCenter().lng;
            mapRight_y = mapRight.getCenter().lat;
            mapLeft.setCenter([mapRight_x, mapRight_y]);
        });

        // //   放大缩小
        // mapLeft.on("zoom", function() {
        //     mapLeft_zoom = mapLeft.getZoom();
        //     mapRight.setZoom(mapLeft_zoom); 
        // });
        // mapRight.on("zoom", function() {
        //     mapRight_zoom = mapRight.getZoom();
        //     mapLeft.setZoom(mapRight_zoom); 
        // });

        // // 倾斜
        // mapLeft.on("pitch", function() {
        //     mapLeft_pitch = mapLeft.getPitch();
        //     mapRight.setPitch(mapLeft_pitch);
        // });
        // mapRight.on("pitch", function() {
        //     mapRight_pitch = mapRight.getPitch();
        //     mapLeft.setPitch(mapRight_pitch);
        // });

        // // 旋转
        // mapRight.on("rotate", function() {
        //     mapRight_bear = mapRight.getBearing();
        //     mapLeft.setBearing(mapRight_bear);
        // });
        // mapLeft.on("rotate", function() {
        //     mapLeft_bear = mapLeft.getBearing();
        //     mapRight.setBearing(mapLeft_bear);
        // });

        // 导航选择事件
        $("#navigation").on("click", "li", function (e) {
            const val = $(this).attr('value')
            console.log('导航选择', e, val)
            $(this).addClass('active').siblings().removeClass('active');
            if (val === 'A') {
                document.getElementById('controls').style.display = 'flex'; // 显示控制面板
                // document.getElementById('map-container').style.display = 'block'; // 显示地图容器
                document.getElementById('map-container').style.display = 'flex'; // 显示地图容器
                document.getElementById('image-container').style.display = 'none'; // 隐藏图片容器

            } else {
                document.getElementById('controls').style.display = 'none'; // 隐藏控制面板
                document.getElementById('map-container').style.display = 'none'; // 隐藏地图容器
                document.getElementById('image-container').style.display = 'flex'; // 显示图片容器
            }
        });
        // // 添加按钮点击事件
        // document.getElementById('removeElements').addEventListener('click', function() {
        //     document.getElementById('controls').remove(); // 移除控制面板
        //     document.getElementById('map-container').remove(); // 移除地图容器
        // });

        function updateImage() {
            // const residentialValue = document.getElementById('residentialSlider').value;
            // const commercialValue = document.getElementById('commercialSlider').value;
            // const constructionValue = document.getElementById('constructionSlider').value;
            // const grasslandValue = document.getElementById('grasslandSlider').value;

            // 获取当前移动的滑块的ID
            const sliderId = event.target.id; // 事件对象需要传入
            const sliderType = sliderId.replace('Slider', ''); // 获取滑块类型
            const value = event.target.value; // 获取当前滑块的值 
            event.target.nextElementSibling.innerText = value; // 更新滑块的显示值
            // const generatedImageName = `img1_${sliderType}+${value}.jpg`; // 根据滑块类型拼接图片名 
            // const generatedImageName = `1000${sliderType}${value >= 0 ? '+' : ''}${value}.jpg`; // 根据滑块类型拼接图片名
            // const generatedImageName = value === '0' ? '1000.jpg' : `1000${sliderType}${value >= 0 ? '+' : ''}${value}.jpg`; // 根据滑块类型拼接图片名

            const currentGroundTruthImageSrc = document.getElementById('groundTruthImage').src; // 获取当前的真实图像源
            const currentImagePrefix = currentGroundTruthImageSrc.split('/').pop().split('.')[0]; // 提取文件名前缀
            const generatedImageName = value === '0' ? `${currentImagePrefix}.jpg` : `${currentImagePrefix}${sliderType}${value >= 0 ? '+' : ''}${value}.jpg`; // 根据滑块类型拼接图片名
            console.log('generatedImageName', generatedImageName)
            document.getElementById('generatedImage').src = `./data/fig/${generatedImageName}`;
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const images = ['./data/fig/1000.jpg', './data/fig/10401.jpg',]; // 图片库
            const groundTruthImage = document.getElementById('groundTruthImage');
            const generatedImage = document.getElementById('generatedImage');

            document.getElementById('changeParcelButton').addEventListener('click', function () {
                const currentSrc = groundTruthImage.src;
                let newSrc;
                do {
                    newSrc = images[Math.floor(Math.random() * images.length)];
                } while (newSrc === currentSrc); // 确保不重复选择当前图片
                groundTruthImage.src = newSrc; // 切换图片
                generatedImage.src = newSrc; // 切换图片 

                // 恢复 grasslandSlider 的值为默认值 0
                document.getElementById('residentialSlider').value = 0; // 添加这一行
                document.getElementById('commercialSlider').value = 0; // 添加这一行
                document.getElementById('constructionSlider').value = 0; // 添加这一行
                document.getElementById('grasslandSlider').value = 0; // 添加这一行
                // updateImage(); // 更新图像以反映新的滑块值

                document.getElementById('residentialSlider').nextElementSibling.innerText = 0; // 更新滑块的显示值
                document.getElementById('commercialSlider').nextElementSibling.innerText = 0; // 更新滑块的显示值
                document.getElementById('constructionSlider').nextElementSibling.innerText = 0; // 更新滑块的显示值
                document.getElementById('grasslandSlider').nextElementSibling.innerText = 0; // 更新滑块的显示值
            });
        });
    </script>
    <script>
        // 假设ate_dict是从后端传递过来的字典
        // const ate_dict = {
        //     'Illumination': {
        //         'Los Angeles': {
        //             'Residential': 0.41,
        //             'Commercial': 0.14,
        //             'Retail': 0.11,
        //             'Brownfield': 0.1,
        //             'Construction': 0.05,
        //             'Industrial': 0.05,
        //             'Grass': 0.91,
        //             'Farmland': -0.02,
        //             'Forest': 0.03
        //         }
        //     }
        //     // ... 其他城市的数据
        // };

        // fetch('./data/ate.json') // 替换为您的 JSON 文件路径
        //     .then(response => response.json())
        //     .then(data => {
        //         ate_dict = data; // 将读取的数据赋值给 ate_dict
        //         console.log('数据已成功加载:', ate_dict);
        //     })
        //     .catch(error => {
        //         console.error('加载 JSON 数据时出错:', error);
        // });

        // function updateAteChart(currentCity, currentIndicator, currentPoi) {
        //     const ateValue = ate_dict[currentIndicator][currentCity][currentPoi];
        //     const chartContainer = document.getElementById('ate-chart');
        //     chartContainer.innerHTML = ''; // 清空之前的图表

        //     // 创建柱状图
        //     const bar = document.createElement('div');
        //     bar.style.width = '50px';
        //     bar.style.height = `${Math.max(ateValue * 100, 0)}px`; // 根据ate值设置高度

        //     console.log('柱子高度',`${Math.max(ateValue * 100, 0)}px`)
        //     bar.style.backgroundColor = 'blue';
        //     bar.style.margin = '0 auto';
        //     chartContainer.appendChild(bar);
        // }

        // 监听选择变化
        // document.getElementById('poiSelect').addEventListener('change', function() {
        //     const currentCity = document.getElementById('citySelect').value; // 假设有一个城市选择器
        //     const currentIndicator = document.getElementById('indicatorSelect').value;
        //     const currentPoi = this.value;
        //     updateAteChart(currentCity, currentIndicator, currentPoi);
        // });

        var ateJson = null;
        function updateChart() {
            if (!ateJson) {
                fetch('./data/ate.json')
                    .then(response => response.json())
                    .then(data => {
                        ateJson = data;
                        updateChartInner();
                    })
                    .catch(error => {
                        console.error('加载ATE数据时出错:', error);
                        alert('无法加载ATE数据，请检查数据格式或网络连接。');
                    });
                return;
            } else {
                updateChartInner();
            }
        }

        function updateChartInner() {
            var ateData = ateJson[currentIndicator][currentCity];
            let currentPoi2 = currentPoi.split('_')[0]
            const firstLetter = currentPoi2.charAt(0)
            const firstLetterCap = firstLetter.toUpperCase()
            const remainingLetters = currentPoi2.slice(1)
            const capitalizedWord = firstLetterCap + remainingLetters
            var ateValue = ateData[capitalizedWord];
            let atePercent1 = Math.random() * 0.5;
            let atePercent2 = Math.random() * 0.5 + 0.5;
            var ateColor1 = atePercentToColor(atePercent1);
            var ateColor2 = atePercentToColor(atePercent2);
            console.log('ateColor1', ateColor1)
            console.log('ateColor2', ateColor2)
            console.log(`linear-gradient(to bottom, ${ateColor1}, ${ateColor2})`)
            // $('#bar').css('background-image', `linear-gradient(to bottom, ${ateColor1}, ${ateColor2})`);
            // $('#bar').css('background-image', `linear-gradient(to bottom, ${ateColor1}, ${ateColor2})`);
            
            
            // 添加以下代码以更新 indicator_span 的值
            const indicatorValues = {
                'Clutter': 1,
                'Trespass': 5,
                'Over_illumination': 25000
            };
            document.getElementById('indicator_span').innerText = indicatorValues[currentIndicator] || 25000; // 默认值为0


            // $('#bar').attr('data-value', atePercent * 100);
            // let height = Math.abs(ateValue) * 1000
            let height = (ateValue+0.4)* 220 
            $('#bar').css('height', ateValue <= 0.9 ? height + 'px' : '500px');
            $('#bar').attr('data-value', ateValue);
            $('#bar').attr('data-value', 'ATE = ' + ateValue.toFixed(2)).css('white-space', 'nowrap');
            // let word = ateData[capitalizedWord+"_word"]
            // $('#word').text(word);
        
        
        }

        function atePercentToColor(percent) {
            var r, g, b;
            if (percent < 0.25) {
                r = 255;
                g = 255 * (percent * 4);
                b = 0;
            } else if (percent < 0.5) {
                r = 255 * ((0.5 - percent) * 4);
                g = 255;
                b = 0;
            } else if (percent < 0.75) {
                r = 0;
                g = 255;
                b = 255 * ((percent - 0.5) * 4);
            } else {
                r = 0;
                g = 255 * ((1 - percent) * 4);
                b = 255;
            }
            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }
    </script>
</body>

</html>